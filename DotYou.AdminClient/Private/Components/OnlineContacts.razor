@using System.Timers
@using DotYou.Types.Admin
@inject IChatClient _chatClient

@foreach (var av in this._availableContacts)
{
    <ContactCardMicro Contact="@av.Contact" NotificationCount="@GetNotificationCount(av.Contact.DotYouId.GetValueOrDefault())" IsOnline="@av.IsChatAvailable" OnClick="HandleClick"/>
}

@code {

    //hack: really neeed just one object here managing the list of contacts but i claim #prototrial
    private readonly Dictionary<DotYouIdentity, int> notificationCounts = new Dictionary<DotYouIdentity, int>();
    private readonly List<AvailabilityStatus> _availableContacts = new List<AvailabilityStatus>();
    private Timer _timer;

    [Parameter]
    public EventCallback<Contact> OnClick { get; set; }

    public void SetNotificationCount(DotYouIdentity dotYouId, int nc)
    {
        if (notificationCounts.ContainsKey(dotYouId))
        {
            notificationCounts[dotYouId] = nc;
        }
        else
        {
            notificationCounts.Add(dotYouId, nc);
        }
        
        StateHasChanged();
    }
    
    public int GetNotificationCount(DotYouIdentity dotYouId)
    {
        if (notificationCounts.TryGetValue(dotYouId, out var nc))
        {
            return nc;
        }

        return 0;
    }
    
    private void HandleClick(Contact c)
    {
        OnClick.InvokeAsync(c);
    }

    protected override async Task OnInitializedAsync()
    {
        int refreshRate = 1000 * 5;

        _timer = new Timer(refreshRate);
        _timer.Elapsed += TimerElapsed;
        _timer.AutoReset = true;
        _timer.Enabled = true;
        
        _timer.Start();

        await RefreshContacts();
    }
    
    private async void TimerElapsed(object sender, ElapsedEventArgs e)
    {
        await RefreshContacts();
    }

    private async Task RefreshContacts()
    {
        var response = await _chatClient.GetAvailableContacts(PageOptions.Default);

        if (response.IsSuccessStatusCode && response.Content != null)
        {
            //TODO: this just handles the first page but really we need to get multiple
            var page = response.Content;
            var ordered = page.Results.OrderBy(av => av.Contact.GivenName);

            _availableContacts.Clear();
            _availableContacts.AddRange(ordered);
        }

        StateHasChanged();
    }

}