"use strict";(self.webpackChunkowner_app=self.webpackChunkowner_app||[]).push([[713],{5713:function(e,t,r){r.d(t,{Z:function(){return w},i:function(){return m}});var n=r(4165),a=r(1413),i=r(5861),o=r(7408),u=r(9631),c=r(8534),s=r(9439),d=r(5671),l=r(3144),p=r(9340),v=r(1129),f=r(7186),h=r(5144),y=r(2008),x=r(9189),b=r(2826),Z=function(e){(0,p.Z)(r,e);var t=(0,v.Z)(r);function r(e){var n;return(0,d.Z)(this,r),(n=t.call(this,e)).transitProvider=void 0,n.transitProvider=b.Z.getInstance(e),n}return(0,l.Z)(r,[{key:"getProfileAttributes",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var o,c,s,d,l,p=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=u.P.StandardProfileId,c=(0,u.H3)(o),s={targetDrive:c,fileType:[u.Uz.AttributeFileType],tagsMatchAll:r?[r]:void 0},e.next=5,this.transitProvider.QueryBatch(t,s);case 5:return d=e.sent,l=d.searchResults.sort((function(e,t){return e.priority-t.priority})),e.next=9,Promise.all(l.map(function(){var e=(0,i.Z)((0,n.Z)().mark((function e(i){var u,s,l;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s={id:"",type:r,sectionId:"",priority:-1,data:null,profileId:o,acl:null===(u=i.serverMetadata)||void 0===u?void 0:u.accessControlList},e.next=3,p.transitProvider.GetPayload(t,c,i.fileId,i.fileMetadata,i.sharedSecretEncryptedKeyHeader,d.includeMetadataHeader);case 3:return l=e.sent,e.abrupt("return",(0,a.Z)((0,a.Z)({},s),l));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 9:return e.abrupt("return",e.sent.filter((function(e){return!!e})));case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}],[{key:"getInstance",value:function(e){return r.instance||(r.instance=new r(e)),r.instance}}]),r}(y.$);Z.instance=void 0;var g=function(e){(0,p.Z)(r,e);var t=(0,v.Z)(r);function r(e){var n;if((0,d.Z)(this,r),!e)throw"[ContactSourceProvider] Shared Secret is required";return(n=t.call(this,e)).externalDataProvider=void 0,n.externalMediaProvider=void 0,n.circleNetworkProvider=void 0,n.circleNetworkRequestProvider=void 0,n.externalDataProvider=Z.getInstance(e),n.circleNetworkProvider=f.I.getInstance(e),n.circleNetworkRequestProvider=h.e.getInstance(e),n.externalMediaProvider=x.Q.getInstance(e),n}return(0,l.Z)(r,[{key:"fetchConnectionInfo",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,o,u;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this.circleNetworkProvider.getConnectionInfo(t,!0),this.queryConnectionAttributes(t)]);case 2:if(r=e.sent,i=(0,s.Z)(r,2),o=i[0],u=i[1],!o){e.next=23;break}if(null===o||void 0===o||!o.originalContactData){e.next=22;break}return e.t0=a.Z,e.t1=a.Z,e.t2={givenName:o.originalContactData.givenName,surname:o.originalContactData.surname},e.next=13,this.getPhotoDataFromPublic(t,o.originalContactData.imageId);case 13:return e.t3=e.sent,e.t4={name:e.t2,image:e.t3},e.t5=u,e.t6=(0,e.t1)(e.t4,e.t5),e.t7={},e.t8={source:"contact"},e.abrupt("return",(0,e.t0)(e.t6,e.t7,e.t8));case 22:return e.abrupt("return",u);case 23:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryConnectionAttributes",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,a,i,o,c,d,l,p,v,f,h,y,x,b,Z,g,k,m;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=Promise,e.next=4,this.externalDataProvider.getProfileAttributes(t,u.H1.Name.type);case 4:if(e.t2=r=e.sent,e.t1=null===e.t2,e.t1){e.next=8;break}e.t1=void 0===r;case 8:if(!e.t1){e.next=12;break}e.t3=void 0,e.next=13;break;case 12:e.t3=r[0];case 13:return e.t4=e.t3,e.next=16,this.externalDataProvider.getProfileAttributes(t,u.H1.PhoneNumber.type);case 16:if(e.t6=a=e.sent,e.t5=null===e.t6,e.t5){e.next=20;break}e.t5=void 0===a;case 20:if(!e.t5){e.next=24;break}e.t7=void 0,e.next=25;break;case 24:e.t7=a[0];case 25:return e.t8=e.t7,e.next=28,this.externalDataProvider.getProfileAttributes(t,u.H1.Location.type);case 28:if(e.t10=i=e.sent,e.t9=null===e.t10,e.t9){e.next=32;break}e.t9=void 0===i;case 32:if(!e.t9){e.next=36;break}e.t11=void 0,e.next=37;break;case 36:e.t11=i[0];case 37:return e.t12=e.t11,e.next=40,this.externalDataProvider.getProfileAttributes(t,u.H1.Birthday.type);case 40:if(e.t14=o=e.sent,e.t13=null===e.t14,e.t13){e.next=44;break}e.t13=void 0===o;case 44:if(!e.t13){e.next=48;break}e.t15=void 0,e.next=49;break;case 48:e.t15=o[0];case 49:return e.t16=e.t15,e.next=52,this.externalDataProvider.getProfileAttributes(t,u.H1.Photo.type);case 52:if(e.t18=c=e.sent,e.t17=null===e.t18,e.t17){e.next=56;break}e.t17=void 0===c;case 56:if(!e.t17){e.next=60;break}e.t19=void 0,e.next=61;break;case 60:e.t19=c[0];case 61:return e.t20=e.t19,e.t21=[e.t4,e.t8,e.t12,e.t16,e.t20],e.next=65,e.t0.all.call(e.t0,e.t21);case 65:if(y=e.sent,x=(0,s.Z)(y,5),b=x[0],Z=x[1],g=x[2],k=x[3],m=x[4],e.t22={givenName:null===b||void 0===b||null===(d=b.data)||void 0===d?void 0:d[u.mA.GivenNameId],surname:null===b||void 0===b||null===(l=b.data)||void 0===l?void 0:l[u.mA.SurnameId]},e.t23={city:null===g||void 0===g||null===(p=g.data)||void 0===p?void 0:p[u.wS.City],country:null===g||void 0===g||null===(v=g.data)||void 0===v?void 0:v[u.wS.Country]},e.t24={number:null===Z||void 0===Z||null===(f=Z.data)||void 0===f?void 0:f[u.Kx.PhoneNumber]},e.t25={date:null===k||void 0===k||null===(h=k.data)||void 0===h?void 0:h[u.ir.Date]},!m){e.next=82;break}return e.next=79,this.queryConnectionPhotoData(t,m.data[u.mA.ProfileImageId]);case 79:e.t26=e.sent,e.next=83;break;case 82:e.t26=void 0;case 83:return e.t27=e.t26,e.abrupt("return",{source:"contact",name:e.t22,location:e.t23,phone:e.t24,birthday:e.t25,image:e.t27});case 87:return e.prev=87,e.t28=e.catch(0),e.abrupt("return",void 0);case 90:case"end":return e.stop()}}),e,this,[[0,87]])})));return function(t){return e.apply(this,arguments)}}()},{key:"queryConnectionPhotoData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var a;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.externalMediaProvider.getDecryptedImageData(t,(0,u.H3)(u.P.StandardProfileId),r);case 2:return a=e.sent,e.abrupt("return",{pixelWidth:a.pixelWidth,pixelHeight:a.pixelHeight,contentType:a.contentType,content:u.j4.uint8ArrayToBase64(new Uint8Array(a.content))});case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchPendingInfo",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var a;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.circleNetworkRequestProvider.getPendingRequest(t);case 3:if((a=e.sent).senderDotYouId!==t){e.next=16;break}if(null===a||void 0===a||!a.contactData){e.next=16;break}if(e.t0={givenName:a.contactData.givenName,surname:a.contactData.surname},!r){e.next=13;break}return e.next=10,this.getPhotoDataFromPublic(t,a.contactData.imageId);case 10:e.t1=e.sent,e.next=14;break;case 13:e.t1=void 0;case 14:return e.t2=e.t1,e.abrupt("return",{name:e.t0,image:e.t2,source:"pending"});case 16:e.next=21;break;case 18:return e.prev=18,e.t3=e.catch(0),e.abrupt("return");case 21:case"end":return e.stop()}}),e,this,[[0,18]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchDataFromPublic",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,o,c,s,d,l,p,v,f,h,y,x,b,Z;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p=new u.pt({api:u.Ii.YouAuth,root:t}),e.next=3,p.fileReadOnlyProvider.GetFile("public.json");case 3:if(v=e.sent,f=null===v||void 0===v||null===(i=v.get("name"))||void 0===i?void 0:i[0],h=null===v||void 0===v||null===(o=v.get("photo"))||void 0===o?void 0:o[0],(y=null!==(c=null===v||void 0===v||null===(s=v.get(null===h||void 0===h||null===(d=h.payload)||void 0===d||null===(l=d.data)||void 0===l?void 0:l.profileImageId))||void 0===s?void 0:s[0])&&void 0!==c?c:void 0)&&r){e.next=9;break}return e.abrupt("return",{name:null!==f&&void 0!==f&&null!==(x=f.payload)&&void 0!==x&&x.data.givenName||null!==f&&void 0!==f&&null!==(b=f.payload)&&void 0!==b&&b.data.surname?{givenName:f.payload.data.givenName,surname:f.payload.data.surname}:void 0,image:void 0,source:"public"});case 9:return Z=y.additionalThumbnails.reduce((function(e,t){return e.pixelWidth<t.pixelWidth&&t.pixelWidth<=250?t:e}),(0,a.Z)((0,a.Z)({},y.header.fileMetadata.appData.previewThumbnail),{},{pixelWidth:20,pixelHeight:20})),e.abrupt("return",{name:f.payload.data.givenName||f.payload.data.surname?{givenName:f.payload.data.givenName,surname:f.payload.data.surname}:void 0,image:{pixelWidth:Z.pixelWidth,pixelHeight:Z.pixelHeight,contentType:Z.contentType,content:Z.content.toString()},source:"public"});case 11:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getPhotoDataFromPublic",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,o,c,s,d;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=new u.pt({api:u.Ii.YouAuth,root:t}),e.next=3,o.fileReadOnlyProvider.GetFile("public.json");case 3:if(c=e.sent,s=null===c||void 0===c||null===(i=c.get(r))||void 0===i?void 0:i[0]){e.next=7;break}return e.abrupt("return");case 7:return d=s.additionalThumbnails.reduce((function(e,t){return e.pixelWidth<t.pixelWidth&&t.pixelWidth<=250?t:e}),(0,a.Z)((0,a.Z)({},s.header.fileMetadata.appData.previewThumbnail),{},{pixelWidth:20,pixelHeight:20})),e.abrupt("return",{pixelWidth:d.pixelWidth,pixelHeight:d.pixelHeight,contentType:d.contentType,content:d.content.toString()});case 9:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()}],[{key:"getInstance",value:function(e){return r.instance||(r.instance=new r(e)),r.instance}}]),r}(y.$);g.instance=void 0;var k=r(8609),m=function(e){var t;if(e.image&&!e.imageFileId){var r=u.j4.base64ToUint8Array(e.image.content);t=window.URL.createObjectURL(new Blob([r],{type:e.image.contentType}))}return{id:e.id,name:e.name,location:e.location,phone:e.phone,birthday:e.birthday,imageFileId:e.imageFileId,imageUrl:t,dotYouId:e.dotYouId,source:e.source}},w=function(e){var t=e.dotYouId,r=e.id,s=e.loadPendingProfilePicture,d=(0,k.ZP)().getSharedSecret,l=c.m.getInstance(d()),p=g.getInstance(d()),v=(0,o.useQueryClient)(),f=function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,o,c,s,d,v,f,h,y,x,b;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.dotYouId,i=t.id,o=t.loadPendingProfilePicture,r){e.next=8;break}if(i){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,l.getContactByUniqueId(i);case 6:return c=e.sent,e.abrupt("return",c);case 8:return e.next=10,l.getContactByUniqueId(u.j4.toGuidId(r));case 10:if(!(s=e.sent)){e.next=13;break}return e.abrupt("return",s);case 13:return e.next=15,p.fetchConnectionInfo(r);case 15:if(!(d=e.sent)){e.next=21;break}return e.next=19,l.saveContact((0,a.Z)((0,a.Z)({},d),{},{dotYouId:r}));case 19:return v=e.sent,e.abrupt("return",m(v));case 21:if(console.debug("Contact book and connection detail is empty for ".concat(r,", gone hunting for best fallback")),f){e.next=36;break}return e.next=25,p.fetchPendingInfo(r,o);case 25:if(e.t1=h=e.sent,e.t0=null!==e.t1,!e.t0){e.next=29;break}e.t0=void 0!==h;case 29:if(!e.t0){e.next=33;break}e.t2=h,e.next=34;break;case 33:e.t2=void 0;case 34:y=e.t2,f=y?(0,a.Z)((0,a.Z)({},s),y):f;case 36:if(f){e.next=41;break}return e.next=39,p.fetchDataFromPublic(r,o);case 39:x=e.sent,f=x?(0,a.Z)((0,a.Z)({},s),x):f;case 41:if(!f){e.next=50;break}if(!o){e.next=49;break}return e.next=45,l.saveContact((0,a.Z)((0,a.Z)({},f),{},{dotYouId:r}));case 45:return b=e.sent,e.abrupt("return",m(b));case 49:return e.abrupt("return",m(f));case 50:return e.abrupt("return",void 0);case 51:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),h=function(){var e=(0,i.Z)((0,n.Z)().mark((function e(r){var i,o,u,c,s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((o=r.contact).id&&o.dotYouId){e.next=4;break}return console.warn("Missing data to fetch new contact data reliable"),e.abrupt("return");case 4:return e.next=6,p.fetchConnectionInfo(o.dotYouId);case 6:if(e.t1=i=e.sent,e.t0=null!==e.t1,!e.t0){e.next=10;break}e.t0=void 0!==i;case 10:if(!e.t0){e.next=14;break}e.t2=i,e.next=15;break;case 14:e.t2=void 0;case 15:if(c=e.t2,!(u=c?(0,a.Z)((0,a.Z)({},o),c):void 0)){e.next=24;break}return e.next=20,l.saveContact((0,a.Z)((0,a.Z)({},u),{},{dotYouId:o.dotYouId}));case 20:return u=e.sent,e.abrupt("return");case 24:return e.next=26,p.fetchDataFromPublic(t,!0);case 26:return s=e.sent,e.next=29,l.saveContact((0,a.Z)((0,a.Z)({},s),{},{dotYouId:t}));case 29:u=e.sent;case 30:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return{fetch:(0,o.useQuery)(["contact",null!==t&&void 0!==t?t:r,s],(function(){return f({dotYouId:t,id:r,loadPendingProfilePicture:s})}),{refetchOnWindowFocus:!1,onError:function(e){return console.error(e)},retry:!1}),refresh:(0,o.useMutation)(h,{onMutate:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(a){var i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.cancelQueries(["contact",null!==t&&void 0!==t?t:r]);case 2:return i=v.getQueryData(["contact",null!==t&&void 0!==t?t:r]),v.setQueryData(["contact",null!==t&&void 0!==t?t:r],a),e.abrupt("return",{previousContact:i,newContact:a});case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),onError:function(e,n,a){console.error(e),v.setQueryData(["contact",null!==t&&void 0!==t?t:r],a.previousContact)},onSettled:function(){v.invalidateQueries(["contact",t]),v.invalidateQueries(["contact",r])}})}}},7186:function(e,t,r){r.d(t,{I:function(){return f}});var n=r(1413),a=r(4165),i=r(5861),o=r(5671),u=r(3144),c=r(1752),s=r(1120),d=r(9340),l=r(1129),p=r(2008),v=r(3990),f=function(e){(0,d.Z)(r,e);var t=(0,l.Z)(r);function r(e){var n;if((0,o.Z)(this,r),!e)throw"[CircleNetworkProvider] Shared Secret is required";return(n=t.call(this,e)).root="/circles/connections",n}return(0,u.Z)(r,[{key:"blockDotYouId",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var n,i,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,c.Z)((0,s.Z)(r.prototype),"createAxiosClient",this).call(this),i=this.root+"/block",o={dotYouId:t},e.abrupt("return",n.post(i,o).then((function(e){return e.data})).catch((0,c.Z)((0,s.Z)(r.prototype),"handleErrorResponse",this)));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"disconnectFromContact",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var n,i,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,c.Z)((0,s.Z)(r.prototype),"createAxiosClient",this).call(this),i=this.root+"/disconnect",o={dotYouId:t},e.abrupt("return",n.post(i,o).then((function(e){return e.data})).catch((0,c.Z)((0,s.Z)(r.prototype),"handleErrorResponse",this)));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getConnections",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var n,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,c.Z)((0,s.Z)(r.prototype),"createAxiosClient",this).call(this),i=this.root+"/connected?"+(0,v.Pz)(t),e.abrupt("return",n.post(i,t).then((function(e){return e.data})));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getBlockedConnections",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var n,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,c.Z)((0,s.Z)(r.prototype),"createAxiosClient",this).call(this),i=this.root+"/blocked?"+(0,v.Pz)(t),e.abrupt("return",n.get(i).then((function(e){return e.data})).catch((0,c.Z)((0,s.Z)(r.prototype),"handleErrorResponse",this)));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getConnectionInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=(0,c.Z)((0,s.Z)(r.prototype),"createAxiosClient",this).call(this),i=this.root+"/status?omitContactData=".concat(!t),o={dotYouId:e};return a.post(i,o).then((function(e){var t,r;return(0,n.Z)((0,n.Z)({},e.data),{},{status:null===(t=e.data)||void 0===t||null===(r=t.status)||void 0===r?void 0:r.toLowerCase()})})).catch((0,c.Z)((0,s.Z)(r.prototype),"handleErrorResponse",this))}}],[{key:"getInstance",value:function(e){return r.instance||(r.instance=new r(e)),r.instance}}]),r}(p.$);f.instance=void 0},8534:function(e,t,r){r.d(t,{m:function(){return p}});var n=r(4165),a=r(5861),i=r(5671),o=r(3144),u=r(9340),c=r(1129),s=r(9631),d=r(2008),l=r(9006),p=function(e){(0,u.Z)(r,e);var t=(0,c.Z)(r);function r(e){var n;if((0,i.Z)(this,r),!e)throw"[ContactProvider] Shared Secret is required";return(n=t.call(this,e))._driveProvider=void 0,n._mediaProvider=void 0,n._driveProvider=new s.l$({api:s.Ii.Owner,sharedSecret:e}),n._mediaProvider=new s.ZN({api:s.Ii.Owner,sharedSecret:e,driveProvider:n._driveProvider}),n}return(0,o.Z)(r,[{key:"saveContact",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var r,a,i,o,u,c,d,p,v,f,h,y;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.id){e.next=13;break}return e.next=3,this.getContactByUniqueId(t.id);case 3:if(e.t1=i=e.sent,e.t0=null===e.t1,e.t0){e.next=7;break}e.t0=void 0===i;case 7:if(!e.t0){e.next=11;break}e.t2=void 0,e.next=12;break;case 11:e.t2=i.fileId;case 12:t.fileId=e.t2;case 13:if(t.fileId){e.next=19;break}return e.next=16,this.getContactByUniqueId(s.j4.toGuidId(t.dotYouId));case 16:c=e.sent,t.id=null!==(o=null===c||void 0===c?void 0:c.id)&&void 0!==o?o:s.j4.getNewId(),t.fileId=null!==(u=null===c||void 0===c?void 0:c.fileId)&&void 0!==u?u:void 0;case 19:if(null===(r=t.image)||void 0===r||!r.content){e.next=24;break}return e.next=22,this._mediaProvider.uploadImage(l.F.ContactTargetDrive,void 0,{requiredSecurityGroup:s.hh.Owner},s.j4.base64ToUint8Array(t.image.content),t.imageFileId,t.image.contentType);case 22:t.imageFileId=e.sent,t.image=void 0;case 24:return!0,d={transferIv:this._driveProvider.Random16(),storageOptions:{overwriteFileId:null!==(a=null===t||void 0===t?void 0:t.fileId)&&void 0!==a?a:"",drive:l.F.ContactTargetDrive},transitOptions:null},p=s.j4.JsonStringify64(t),v=s.j4.stringToUint8Array(p),f=v.length<3e3,h={contentType:"application/json",appData:{tags:[t.id,s.j4.toGuidId(t.dotYouId)],fileType:l.F.ContactFileType,contentIsComplete:f,jsonContent:f?p:null,uniqueId:t.dotYouId?s.j4.toGuidId(t.dotYouId):t.id},payloadIsEncrypted:true},e.next=32,this._driveProvider.Upload(d,h,v,void 0,true);case 32:return y=e.sent,t.fileId=y.file.fileId,e.abrupt("return",t);case 35:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getContactByUniqueId",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var r,a,i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._driveProvider.QueryBatch({targetDrive:l.F.ContactTargetDrive,clientUniqueIdAtLeastOne:[t]});case 2:if(0!=(r=e.sent).searchResults.length){e.next=5;break}return e.abrupt("return");case 5:return r.searchResults.length>1&&console.warn("UniqueId ["+t+"] in contacts has more than one file. Using latest"),a=r.searchResults[0],e.next=9,this._driveProvider.GetPayload(l.F.ContactTargetDrive,a.fileId,a.fileMetadata,a.sharedSecretEncryptedKeyHeader,r.includeMetadataHeader);case 9:return(i=e.sent).fileId=a.fileId,e.abrupt("return",i);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getContactByTag",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var r,a,i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._driveProvider.QueryBatch({targetDrive:l.F.ContactTargetDrive,tagsMatchAtLeastOne:[t]});case 2:if(0!=(r=e.sent).searchResults.length){e.next=5;break}return e.abrupt("return");case 5:return r.searchResults.length>1&&console.warn("Tag ["+t+"] in contacts has more than one file. Using latest"),a=r.searchResults[0],e.next=9,this._driveProvider.GetPayload(l.F.ContactTargetDrive,a.fileId,a.fileMetadata,a.sharedSecretEncryptedKeyHeader,r.includeMetadataHeader);case 9:return(i=e.sent).fileId=a.fileId,e.abrupt("return",i);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getContacts",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(){var t,r,i,o=this,u=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>0&&void 0!==u[0]?u[0]:void 0,r=u.length>1&&void 0!==u[1]?u[1]:10,e.next=4,this._driveProvider.QueryBatch({targetDrive:l.F.ContactTargetDrive,fileType:[l.F.ContactFileType]},{maxRecords:r,cursorState:t,includeMetadataHeader:!0});case 4:if(0!=(i=e.sent).searchResults.length){e.next=7;break}return e.abrupt("return",{results:[],cursorState:""});case 7:return e.next=9,Promise.all(i.searchResults.map(function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var r,a;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t,e.next=3,o._driveProvider.GetPayload(l.F.ContactTargetDrive,r.fileId,r.fileMetadata,r.sharedSecretEncryptedKeyHeader,i.includeMetadataHeader);case 3:return(a=e.sent).fileId=r.fileId,e.abrupt("return",a);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 9:return e.t0=e.sent,e.t1=i.cursorState,e.abrupt("return",{results:e.t0,cursorState:e.t1});case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}],[{key:"getInstance",value:function(e){return r.instance||(r.instance=new r(e)),r.instance}}]),r}(d.$);p.instance=void 0},9006:function(e,t,r){r.d(t,{F:function(){return o}});var n=r(3144),a=r(5671),i=r(9631),o=(0,n.Z)((function e(){(0,a.Z)(this,e)}));o.ContactDriveType=i.j4.toGuidId("contact_drive_type"),o.ContactFileType=100,o.ContactTargetDrive={alias:"2612429d1c3f037282b8d42fb2cc0499",type:"70e92f0f94d05f5c7dcd36466094f3a5"}},9189:function(e,t,r){r.d(t,{Q:function(){return p}});var n=r(4165),a=r(5861),i=r(5671),o=r(3144),u=r(9340),c=r(1129),s=r(9631),d=r(2008),l=r(2826),p=function(e){(0,u.Z)(r,e);var t=(0,c.Z)(r);function r(e){var n;return(0,i.Z)(this,r),(n=t.call(this,e)).transitProvider=void 0,n.transitProvider=l.Z.getInstance(e),n}return(0,o.Z)(r,[{key:"getDecryptedMetadata",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r,a){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.transitProvider.GetFileHeader(t,r,a);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getDecryptedThumbnailMeta",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r,a){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.getDecryptedMetadata(t,r,a).then((function(e){var t;if(e.fileMetadata.appData.previewThumbnail){var r=e.fileMetadata.appData.previewThumbnail,n=s.j4.base64ToUint8Array(r.content),a=window.URL.createObjectURL(new Blob([n],{type:r.contentType}));return{naturalSize:{width:r.pixelWidth,height:r.pixelHeight},sizes:null!==(t=e.fileMetadata.appData.additionalThumbnails)&&void 0!==t?t:[],url:a}}})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getDecryptedImageUrl",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r,a,i){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.getDecryptedImageData(t,r,a,i).then((function(e){return window.URL.createObjectURL(new Blob([e.content],{type:e.contentType}))})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"getDecryptedImageData",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r,a,i){var o,u,c,s,d,l,p,v,f;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.transitProvider.GetFileHeader(t,r,a);case 2:if(!(p=e.sent).fileMetadata.payloadIsEncrypted){e.next=9;break}return e.next=6,this.transitProvider.DecryptKeyHeader(p.sharedSecretEncryptedKeyHeader);case 6:e.t0=e.sent,e.next=10;break;case 9:e.t0=void 0;case 10:return v=e.t0,f=i?this.transitProvider.GetThumbBytes(t,r,a,v,i.pixelWidth,i.pixelHeight):this.transitProvider.GetPayloadBytes(t,r,a,v),e.t1=null!==(o=null===(u=p.fileMetadata.appData.previewThumbnail)||void 0===u?void 0:u.pixelHeight)&&void 0!==o?o:0,e.t2=null!==(c=null===(s=p.fileMetadata.appData.previewThumbnail)||void 0===s?void 0:s.pixelWidth)&&void 0!==c?c:0,e.t3=null!==(d=null===(l=p.fileMetadata.appData.previewThumbnail)||void 0===l?void 0:l.contentType)&&void 0!==d?d:"",e.next=17,f;case 17:return e.t4=e.sent,e.abrupt("return",{pixelHeight:e.t1,pixelWidth:e.t2,contentType:e.t3,content:e.t4});case 19:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()}],[{key:"getInstance",value:function(e){return r.instance||(r.instance=new r(e)),r.instance}}]),r}(d.$);p.instance=void 0},2826:function(e,t,r){r.d(t,{Z:function(){return v}});var n=r(1413),a=r(4165),i=r(5861),o=r(5671),u=r(3144),c=r(9340),s=r(1129),d=r(9631),l=r(2008),p=new Map,v=function(e){(0,c.Z)(r,e);var t=(0,s.Z)(r);function r(e){var n;return(0,o.Z)(this,r),(n=t.call(this,e.sharedSecret)).driveProvider=void 0,n.driveProvider=e.driveProvider,n}return(0,u.Z)(r,[{key:"QueryBatch",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r,n){var i,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.createAxiosClient(),n||(n={cursorState:void 0,maxRecords:10,includeMetadataHeader:!0}),o={queryParams:r,resultOptionsRequest:n,dotYouId:t},e.abrupt("return",i.post("/transit/query/batch",o).then((function(e){return e.data})));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"GetPayload",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r,n,i,o,u){var c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.payloadIsEncrypted){e.next=6;break}return e.next=3,this.DecryptKeyHeader(o);case 3:e.t0=e.sent,e.next=7;break;case 6:e.t0=void 0;case 7:if(c=e.t0,!i.appData.contentIsComplete||!u){e.next=14;break}return e.next=11,this.driveProvider.DecryptJsonContent(i,c);case 11:return e.abrupt("return",e.sent);case 14:return e.next=16,this.GetPayloadAsJson(t,r,n,c);case 16:return e.abrupt("return",e.sent);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,i,o){return e.apply(this,arguments)}}()},{key:"GetPayloadAsJson",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r,n,i){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.GetPayloadBytes(t,r,n,i).then((function(e){var t=d.j4.byteArrayToString(new Uint8Array(e));try{return JSON.parse(t)}catch(o){console.warn("base JSON.parse failed");var r=function(e,t,r){return e.replace(new RegExp(t,"g"),r)},n=r(t,"\x19",""),a=r(n,"\x14",""),i=JSON.parse(a);return console.warn("... but we fixed it"),i}})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"GetPayloadBytesNoPriorHeader",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r,n){var o,u,c,s=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.createAxiosClient(),u={dotYouId:t,file:{targetDrive:r,fileId:n}},c={responseType:"arraybuffer"},e.abrupt("return",o.post("/transit/query/payload",u,c).then(function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var r,n,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("True"===t.headers.payloadencrypted)){e.next=10;break}return r=d.j4.base64ToUint8Array(t.headers.sharedsecretencryptedheader64),console.log(t),n=d.j4.base64ToUint8Array(t.data.iv),console.log({iv:n}),e.next=8,d.hu.CbcDecrypt(r,n,s.getSharedSecret());case 8:i=e.sent,console.log(i);case 10:return e.abrupt("return",new Uint8Array(t.data));case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){throw console.error(e),e})));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"GetPayloadBytes",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r,n,i){var o,u,c,s=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.createAxiosClient(),u={dotYouId:t,file:{targetDrive:r,fileId:n}},c={responseType:"arraybuffer"},e.abrupt("return",o.post("/transit/query/payload",u,c).then((function(e){if(i){var t=new Uint8Array(e.data);return s.driveProvider.DecryptUsingKeyHeader(t,i).then((function(e){return e}))}return new Uint8Array(e.data)})).catch((function(e){throw console.error(e),e})));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"GetThumbBytes",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r,i,o,u,c){var s,d,l,p=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.createAxiosClient(),d={dotYouId:t,file:{targetDrive:r,fileId:i}},l={responseType:"arraybuffer"},e.abrupt("return",s.post("/transit/query/thumb",(0,n.Z)((0,n.Z)({},d),{},{width:u,height:c}),l).then((function(e){if(o){var t=new Uint8Array(e.data);return p.driveProvider.DecryptUsingKeyHeader(t,o).then((function(e){return e}))}return new Uint8Array(e.data)})).catch((function(e){throw e})));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,i,o){return e.apply(this,arguments)}}()},{key:"GetFileHeader",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r,n){var i,o,u,c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i="".concat(t,"+").concat(r.alias,"-").concat(r.type,"+").concat(n),!p.has(i)){e.next=5;break}return e.next=4,p.get(i);case 4:return e.abrupt("return",e.sent);case 5:return o=this.createAxiosClient(),u={dotYouId:t,file:{targetDrive:r,fileId:n}},c=o.post("/transit/query/header",u).then((function(e){return e.data})).catch((function(e){throw console.error(e),e})),p.set(i,c),e.abrupt("return",c);case 10:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"DecryptKeyHeader",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.driveProvider.DecryptKeyHeader(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}],[{key:"getInstance",value:function(e){if(!r.instance){var t=new d.l$({api:d.Ii.Owner,sharedSecret:e});r.instance=new r({sharedSecret:e,driveProvider:t})}return r.instance}}]),r}(l.$);v.instance=void 0}}]);
//# sourceMappingURL=713.fa2901ef.chunk.js.map